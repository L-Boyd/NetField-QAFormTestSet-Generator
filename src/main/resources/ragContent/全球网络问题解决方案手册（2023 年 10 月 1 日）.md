# 网络问题解决方案手册：https://blog.csdn.net/m0_71071763/article/details/150853116

本手册旨在为IT专业人员提供一个从物理层到应用层的结构化故障排除框架，涵盖排查思路、工具命令和解决方案。

## 全局网络问题解决方案手册

### 1. 手册哲学与核心原则

1. **分层排查 (OSI/TCP-IP模型)** ：从底层（物理层）开始，逐步向上排查（数据链路层、网络层、传输层、应用层）。

2. **替代法** ：用已知正常的设备（线缆、网卡、交换机端口）替换可疑部件，快速定位问题。

3. **变更追溯** ：问题出现前做了什么？系统更新、配置更改、设备重启、网络变动？

4. **文档记录** ：记录正常的网络基准（如延迟、带宽），并维护网络拓扑图和IP地址规划表。

### 2. 全局排查流程图

**开始 → 物理层检查 → 链路层检查 → 网络层检查 → 传输层/应用层检查 → 问题解决**

### 3. 分层排查详解与解决方案

#### 第1层：物理层 (Physical Layer)

**问题症状**：完全无法连接、接口指示灯不亮、频繁断开连接。  

**排查工具**：眼睛、手、替换线缆、交换机管理界面。

|排查点|排查命令/方法|解决方案|
|---|---|---|
|**线缆**|检查水晶头是否损坏，线序是否正确（T568A/B）。使用线缆测试仪。|**更换质量合格的Cat5e/6/6A网线**。确保使用直通线连接不同设备（如PC to Switch），使用交叉线连接同类设备（历史，现代网卡大多支持自动翻转）。|
|**接口**|检查网卡和交换机端口是否有物理损坏、灰尘或氧化。|**清洁接口**，**更换端口**。|
|**指示灯**|观察设备端口指示灯状态。<br>- **常绿**：链路正常<br>- **闪烁**：有数据活动<br>- **熄灭**：无链路<br>- **琥珀色/黄色**：可能故障或速率限制|指示灯熄灭表明物理层问题，检查线缆和端口。|
|**功率不足**|(PoE设备) 设备无法启动或反复重启。|检查交换机PoE功率预算是否足够，升级交换机或使用PoE注入器。|
---

#### 第2层：数据链路层 (Data Link Layer)

**问题症状**：指示灯亮但无数据流、IP地址获取失败、速度慢、丢包。  

**排查工具**：`ethtool` (Linux), `Get-NetAdapter` (Windows), 交换机CLI。

|排查点|排查命令/方法 (Linux)|排查命令/方法 (Windows)|解决方案|
|---|---|---|---|
|**链路状态**|`ethtool <interface>`<br>查看 `Link detected`|`Get-NetAdapter|Select Name, Status, LinkSpeed`|
|**速度/双工**|`ethtool <interface>`<br>查看 `Speed` 和 `Duplex`|网卡属性 -> **高级** 选项卡|**强制设置两端匹配**（见第5章）或**启用自动协商**。不匹配是常见故障源。|
|**MAC地址表**|`ip link show`|`ipconfig /all`|确认MAC地址唯一，无冲突。|
|**VLAN配置**|`cat /proc/net/vlan/config`<br>`ip link show`|`Get-NetAdapter|? { $_.VlanID -ne $ null}`|
|**驱动问题**|`dmesg|grep -i error`<br>`lspci -v`<br>`ethtool -i eth0`|设备管理器 -> 查看有无感叹号|
|**错误统计**|`ethtool -S eth0|grep -i err`<br>`netstat -i` (查看IERR/ERR)|`Performance Monitor`|
---

#### 第3层：网络层 (Network Layer)

**问题症状**：可以获取IP但无法上网、无法访问特定网段、延迟高。  

**排查工具**：**`ping`** **, ** **`traceroute`** **/** **`tracepath`** **, ** **`ip route`** **/** **`route print`** **, ** **`arp`** **/** **`arp -a`**。

|排查点|排查命令/方法 (Linux)|排查命令/方法 (Windows)|解决方案|
|---|---|---|---|
|**IP地址配置**|`ip addr show` 或 `ifconfig`|`ipconfig /all`|确认IP地址、子网掩码、网关正确。是否为APIPA地址（169.254.x.x）？如是，表示DHCP失败。**静态配置** 或**排查DHCP服务器**。|
|**路由表**|`ip route show` 或 `route -n`|`route print`|确认存在指向网关的默认路由（`0.0.0.0/0` 或 `default`）。确认去往目标网段的路由正确。|
|**ARP解析**|`ip neigh show` 或 `arp -n`|`arp -a`|能否看到网关的MAC地址？状态是 `REACHABLE` 还是 `STALE`？**清除ARP缓存** (`ip neigh flush dev eth0`) 并重新ping网关。|
|**网关可达性**|`ping <网关IP>`|`ping <网关IP>`|不通则表明问题在局域网内（交换机ACL？）。通则进行下一步。|
|**外部可达性**|`ping 8.8.8.8`|`ping 8.8.8.8`|不通则问题可能出在网关本身或其上游。通则进行下一步。|
|**DNS解析**|`ping www.google.com`<br>`dig www.google.com`<br>`nslookup www.google.com`|`nslookup www.google.com`|不通IP但通域名，是**DNS问题**。检查`/etc/resolv.conf`或Windows网卡DNS配置。|
|**路径追踪**|`traceroute 8.8.8.8`<br>`tracepath 8.8.8.8`|`tracert 8.8.8.8`|查看数据包在哪一跳丢失或延迟激增，定位故障设备（路由器、防火墙）。|
---

#### 第4层及以上：传输层、应用层

**问题症状**：特定服务（如Web、邮件）无法访问，速度慢，连接超时。  

**排查工具**：`telnet`/`nc` (netcat), `curl`/`wget`, `iptables`/`firewall-cmd`, Wireshark/`tcpdump`。

|排查点|排查命令/方法|解决方案|
|---|---|---|
|**服务监听**|`netstat -tulnp`<br>`ss -tuln` (更佳)|确认目标服务端口是否在监听 (`LISTEN`)。如80端口无Web服务监听。|
|**本地防火墙**|`iptables -L -n -v`<br>`firewall-cmd --list-all`|**添加规则允许相应端口和协议**（如80/TCP, 443/TCP）。|
|**远程连通性**|`telnet <服务器IP> <端口>`<br>`nc -zv <服务器IP> <端口>`|连接失败表明中间网络防火墙阻断了端口。**联系网络管理员** 开通策略。|
|**DNS解析**|`dig A example.com @8.8.8.8`|使用公共DNS测试，判断是否为公司内部DNS服务器问题。|
|**MTU/分片问题**|`ping -s 1472 -M do 8.8.8.8`<br>(1472+28=1500)|如果大包不通小包通，可能是MTU不匹配（常见于PPPoE、VPN环境）。**调整MTU**。|
|**深度包检测**|`sudo tcpdump -i eth0 -n host <目标IP>`<br>**Wireshark**|查看三次握手是否完成（SYN, SYN/ACK, ACK），是否有RST复位连接，分析应用层协议。|
---

### 4. 高级工具与性能测试

1. **带宽测试 (iperf3)**

    - **服务端** : `iperf3 -s`

    - **客户端** : `iperf3 -c <服务器IP> -t 30 -P 4` (测试30秒，4个并行流)

    - **反向测试 (排除接收端问题)** : `iperf3 -c <服务器IP> -R`

    - **UDP测试 (测试丢包和抖动)** : `iperf3 -c <服务器IP> -u -b 100M`

2. **连续Ping测试 (测试稳定性与丢包)**

    - `ping <目标IP> -n 1000` (Windows)

    - `ping <目标IP> -c 1000` (Linux)

    - 观察是否有丢包和延迟波动。

3. **实时流量监控**

    - **Linux** : `nload eth0`, `iftop -i eth0`, `bmon`

    - **Windows** : `Performance Monitor`, 任务管理器 -> 性能 -> 以太网

---

### 5. 强制设置链路速率与双工模式

**警告：确保链路两端设置一致！**

- **Linux (临时)**

```Bash

# 设置千兆全双工
sudo ethtool -s eth0 speed 1000 duplex full autoneg off

# 设置百兆全双工
sudo ethtool -s eth0 speed 100 duplex full autoneg off

# 恢复自动协商 (首选)
sudo ethtool -s eth0 autoneg on
```

- **Linux (永久 - Ubuntu/Debian)**

编辑 `/etc/netplan/*.yaml`，添加：

```YAML

ethernets:
  eth0:
    ...
    # 添加以下两行
    link-local: []
    ethtool:
      autoneg: off
      duplex: full
      speed: 1000
    ...
```

运行 `sudo netplan apply`。

- **Windows**

网卡属性 -> **高级** -> **Speed & Duplex** -> 选择值 -> **确定**。

---

### 6. 常见场景快速索引

|场景|最可能原因|首要排查点|
|---|---|---|
|**完全无法上网**|物理断开、IP配置错误|1. 指示灯 2. `ipconfig` (是否获得有效IP) 3. `ping 网关`|
|**能上QQ但打不开网页**|DNS解析失败|`nslookup www.baidu.com`|
|**访问内部服务器慢，外部正常**|内部网络环路或交换机性能|交换机STP状态、错误包计数|
|**WiFi有信号但无法连接**|DHCP地址池耗尽、认证问题|路由器日志、尝试静态IP|
|**网速远低于预期**|双工不匹配、网线质量差、驱动问题|`ethtool` 查看速度/双工，更换网线|
|**间歇性断线**|网线接触不良、电磁干扰、过热|检查物理连接，更换端口和网线|
---

**总结**：本手册提供了一个系统性的框架。遇到问题时，切勿盲目尝试，请遵循从底层到高层的顺序，逐步缩小范围，结合替代法和工具验证，才能高效地解决复杂的网络问题。

需要我再补充一份“常见网络问题排查命令速查表”（含Windows/Linux双系统），方便你快速查阅吗？
> （注：文档部分内容可能由 AI 生成）